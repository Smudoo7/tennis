
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TCO Doppelmaster 2025 ‚Äì Public Viewer (stacked stats + QR)</title>
<style>
  :root{
    --bg: #0f1220;
    --card: #15192e;
    --muted: #8b91a7;
    --text: #e7e9f3;
    --accent: #6ee7b7;
    --accent-2: #60a5fa;
    --danger: #f87171;
    --warn: #fbbf24;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 16px;
    --safe-b: env(safe-area-inset-bottom, 0);
    --safe-t: env(safe-area-inset-top, 0);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans";
    background: radial-gradient(1200px 800px at 20% -10%, #1b2146 0%, #12162a 50%, #0d1020 100%);
    color:var(--text);
    line-height:1.45;
  }
  header{
    position:sticky; top:0; z-index:10; backdrop-filter: blur(10px);
    background: rgba(15,18,32,.7);
    padding:12px 16px calc(8px + var(--safe-t)); border-bottom:1px solid #1f2446;
  }
  .container{max-width:1200px; margin:0 auto; padding:16px}
  h1{font-size:clamp(18px, 3.2vw, 32px); margin:6px 0 4px}
  .sub{color:var(--muted); font-size:12px}
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns: repeat(2, minmax(0,1fr));}
  @media (max-width: 720px){ .grid.cols-2{grid-template-columns: 1fr;} }

  .tabs{display:none}
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.02), transparent) , var(--card);
    border:1px solid #222a52;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:14px;
  }
  .card h2{margin:0 0 10px; font-size:18px}
  .muted{color:var(--muted)}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .badge{ padding:4px 8px; font-size:12px; border-radius:999px; border:1px solid #2d3666; color:#9fb0e0; background:#0f142a;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0f142a; border:1px solid #2b3568; color:#c7ceef; font-size:12px}
  .hint{font-size:12px; color:var(--muted)}

  table{width:100%; border-collapse:collapse; font-size:14px; overflow:hidden; border-radius:12px}
  thead th{ text-align:left; font-weight:600; color:#aab2d8; background:#0f142a; border-bottom:1px solid #26305f; padding:10px 8px;}
  tbody td{padding:10px 8px; border-bottom:1px dashed #253060}
  tbody tr:hover{background:#10163a}

  .kpi{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px}
  .kpi .tile{ background: radial-gradient(400px 200px at 120% -20%, rgba(96,165,250,.2), transparent 70%) , #121734;
    border:1px solid #23306a; border-radius:16px; padding:14px; }
  .tile .label{font-size:12px; color:var(--muted)}
  .tile .value{font-size:18px; font-weight:700}
  @media (max-width: 900px){ .kpi{grid-template-columns: repeat(2, 1fr);} }
  @media (max-width: 520px){ .kpi{grid-template-columns: 1fr;} }

  /* Match cards */
  .match-card{border:1px solid #2d376b; border-radius:16px; padding:12px; background:#0f142a}
  .match-card .title{color:#a8b2e2; font-size:12px; margin-bottom:8px}
  .team-row{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin:8px 0}
  .team-row .name{font-weight:800; min-width:56px}
  .team-row .stats{display:flex; gap:16px}
  /* Stacked stats for public view */
  .statcol{display:flex; flex-direction:column; gap:6px; min-width:90px}
  .stat{background:#0e1431; border:1px solid #2b3568; border-radius:12px; padding:8px 10px}
  .stat .label{display:block; font-size:11px; color:#9aa6d9; margin-bottom:4px}
  .stat .value{font-weight:800; font-size:16px}
  @media (max-width:480px){
    .team-row{flex-direction:row; align-items:flex-start}
    .team-row .name{min-width:auto}
  }

  /* KO */
  .ko-title{color:#a8b2e2; font-size:12px; margin-bottom:8px}

  /* Bottom nav (optional ‚Äì hidden in public) */
  .bottom-nav{ display:none }

  main{ padding-bottom: calc(16px + var(--safe-b)); }

  /* QR Overlay */
  .overlay{
    position: fixed; inset:0; background: rgba(5,7,15,.8); backdrop-filter: blur(6px);
    display:none; align-items:center; justify-content:center; z-index:50;
  }
  .overlay.open{ display:flex }
  .qr-card{
    width:min(520px, 92vw);
    background: linear-gradient(180deg, rgba(255,255,255,.03), transparent), #121734;
    border:1px solid #263266; border-radius:18px; padding:16px; box-shadow: var(--shadow);
  }
  .qr-grid{ display:grid; grid-template-columns: 1fr; gap:12px; justify-items:center }
  .qr-grid img{ width: min(360px, 70vw); aspect-ratio:1; border-radius:12px; background:#fff }
  .qr-row{ display:flex; gap:8px; width:100% }
  .qr-row input{ flex:1 }
  .sync{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid #2b3568; background:#0f142a; color:#c7ceef; font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <h1>üèÜ TCO Doppelmaster 2025 <span class="badge">Zuschauermodus</span></h1>
          <div class="sub">Gruppenphase & KO ¬∑ 4 Pl√§tze ¬∑ A auf 1‚Äì2 ¬∑ B auf 3‚Äì4</div>
        </div>
        <div class="row" style="gap:8px">
          <span id="syncBadge" class="sync">üîÑ Verbinden‚Ä¶</span>
          <button class="btn ghost" id="qrBtn" title="QR teilen">QR teilen</button>
          <button class="btn" id="downloadJson" title="Export JSON">Export</button>
        </div>
      </div>
      <div class="kpi" id="kpis"></div>
    </div>
  </header>

  <main class="container">
    <section id="plan" class="card">
      <div class="row" style="justify-content:space-between">
        <h2>üóìÔ∏è Spielplan</h2>
        <span class="pill">Nur Lesen ‚Ä¢ √ñffentlich</span>
      </div>
      <div id="schedule"></div>
    </section>

    <section id="tables" class="card">
      <h2>üìä Live‚ÄëTabellen</h2>
      <div class="grid cols-2">
        <div>
          <div class="row"><h3>Gruppe A</h3><span class="badge">Platz 1‚Äì2</span></div>
          <div id="tableA"></div>
        </div>
        <div>
          <div class="row"><h3>Gruppe B</h3><span class="badge">Platz 3‚Äì4</span></div>
          <div id="tableB"></div>
        </div>
      </div>
    </section>

    <section id="ko" class="card">
      <h2>ü•á KO‚ÄëPhase</h2>
      <div id="koBracket" class="grid cols-2"></div>
    </section>
  </main>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
    <div class="qr-card">
      <div class="qr-grid">
        <h3 id="qrTitle" style="margin:0">üîó Teilen / QR-Code</h3>
        <img id="qrImg" alt="QR-Code zum √ñffnen">
        <div class="qr-row">
          <input type="text" id="shareLink" readonly>
          <button class="btn" id="copyBtn">Kopieren</button>
          <button class="btn ghost" id="closeOverlay">Schlie√üen</button>
        </div>
        <div class="hint">Tipp: Web Share (Android/iOS) ‚Äì wenn verf√ºgbar ‚Äì nutzt den nativen Share‚ÄëDialog.</div>
      </div>
    </div>
  </div>

<script>
// Public-only page (no token, no admin)
const TOURNAMENT_NAME = "TCO Doppelmaster 2025";
const TOURNAMENT_ID = "TCO%20Doppelmaster%202025";
const API = `/.netlify/functions/state?t=${TOURNAMENT_ID}`;
const KEY_LOCAL = "tco_doppelmaster_state_public_viewer_stacked";
const USE_LOCAL_CACHE = true;

const syncBadge = document.getElementById("syncBadge");
function setSyncStatus(text){ syncBadge.textContent = text; }

// Fetch
async function serverLoad() {
  try {
    const res = await fetch(API, { method: "GET" });
    if(!res.ok) throw new Error("GET failed");
    const data = await res.json();
    setSyncStatus("‚úÖ Verbunden");
    return data || {};
  } catch(e) {
    setSyncStatus("‚ö†Ô∏è Offline/Serverfehler ‚Äì lokaler Cache");
    return null;
  }
}

function loadLocal(){ try { return JSON.parse(localStorage.getItem(KEY_LOCAL)) || {}; } catch { return {}; } }
function saveLocal(s){ try { localStorage.setItem(KEY_LOCAL, JSON.stringify(s)); } catch {} }

// Default state
let state = {};
function defaultConfig(){ return { groups: { A: ["A1","A2","A3","A4","A5"], B: ["B1","B2","B3","B4"] }, avoidFirstA5: true }; }
function ensureState(){
  if(!state.config) state.config = defaultConfig();
  if(!state.schedule) state.schedule = generateSchedule(state.config);
  if(!state.matches) state.matches = {};
  for(const [id] of state.schedule){
    if(!state.matches["g"+id]) state.matches["g"+id] = {sets1:"", sets2:"", games1:"", games2:""};
  }
  if(!state.KO) state.KO = { SF1:{t1:"A1", t2:"B2", s1:"", s2:""}, SF2:{t1:"B1", t2:"A2", s1:"", s2:""}, F:{t1:"", t2:"", s1:"", s2:""}, P3:{t1:"", t2:"", s1:"", s2:""} };
}

// Round-robin & schedule
function roundRobin(teams){
  const list = teams.slice();
  if(list.length % 2 === 1) list.push("BYE");
  const n = list.length, rounds = n-1, half = n/2;
  const out = [], arr = list.slice();
  for(let r=0; r<rounds; r++){
    const pairings = [];
    for(let i=0; i<half; i++){
      const t1 = arr[i], t2 = arr[n-1-i];
      if(t1!=="BYE" && t2!=="BYE") pairings.push([t1,t2]);
    }
    out.push(pairings);
    const fixed = arr[0], rest = arr.slice(1);
    rest.unshift(rest.pop()); arr.splice(0, arr.length, fixed, ...rest);
  }
  return out;
}
function generateSchedule(config){
  const A = config.groups.A.slice(), B = config.groups.B.slice();
  const rrA = roundRobin(A), rrB = roundRobin(B);
  if(config.avoidFirstA5 && rrA.length>0 && rrA[0].length>0){
    const lastA = A[A.length-1], firstPair = rrA[0][0];
    if(firstPair.includes(lastA)){
      for(let i=1;i<rrA[0].length;i++){
        if(!rrA[0][i].includes(lastA)){ const tmp = rrA[0][0]; rrA[0][0] = rrA[0][i]; rrA[0][i] = tmp; break; }
      }
    }
  }
  const totalRounds = Math.max(rrA.length, rrB.length);
  const schedule = []; let id = 1;
  for(let r=0; r<totalRounds; r++){
    const aPairs = rrA[r] || [], bPairs = rrB[r] || [];
    for(let i=0;i<2;i++){ if(aPairs[i]) schedule.push([id++, `Runde ${r+1}`, `Platz ${i+1}`, aPairs[i][0], aPairs[i][1], 'A']); }
    for(let i=0;i<2;i++){ if(bPairs[i]) schedule.push([id++, `Runde ${r+1}`, `Platz ${i+3}`, bPairs[i][0], bPairs[i][1], 'B']); }
  }
  return schedule;
}

// Render schedule with stacked displays
function renderSchedule(){
  const wrap = document.getElementById("schedule");
  wrap.innerHTML = "";
  const sched = state.schedule;
  const rounds = {};
  for(const m of sched){ const r = m[1]; if(!rounds[r]) rounds[r] = []; rounds[r].push(m); }
  Object.keys(rounds).forEach((round,i)=>{
    const r = document.createElement("div");
    r.className = "card"; r.style.margin = "12px 0";
    r.innerHTML = `<div class="row" style="justify-content:space-between; align-items:center">
      <div class="row"><h3 style="margin:0">${round}</h3><span class="badge">Parallel: bis zu 4 Pl√§tze</span></div>
      <span class="muted">ab Spiel #${rounds[round][0][0]}</span>
    </div>`;
    const rwrap = document.createElement("div"); rwrap.className = "grid cols-2"; r.appendChild(rwrap); wrap.appendChild(r);

    rounds[round].forEach(([id, , court, t1, t2, grp])=>{
      const m = state.matches["g"+id] || {sets1:"", sets2:"", games1:"", games2:""};
      const card = document.createElement("div");
      card.className = "match-card";
      const s1 = m.sets1 || "‚Äî", g1 = m.games1 || "‚Äî";
      const s2 = m.sets2 || "‚Äî", g2 = m.games2 || "‚Äî";
      card.innerHTML = `
        <div class="title">#${id} ¬∑ ${court} ¬∑ Gruppe ${grp}</div>
        <div class="team-row">
          <span class="name">${t1}</span>
          <div class="stats">
            <div class="statcol">
              <div class="stat"><span class="label">S√§tze</span><div class="value">${s1}</div></div>
              <div class="stat"><span class="label">Spiele</span><div class="value">${g1}</div></div>
            </div>
          </div>
        </div>
        <div class="team-row">
          <span class="name">${t2}</span>
          <div class="stats">
            <div class="statcol">
              <div class="stat"><span class="label">S√§tze</span><div class="value">${s2}</div></div>
              <div class="stat"><span class="label">Spiele</span><div class="value">${g2}</div></div>
            </div>
          </div>
        </div>`;
      rwrap.appendChild(card);
    });
  });
}

function isNumber(x){ return x!=="" && !isNaN(Number(x)); }
function computeStandings(){
  const groups = state.config.groups;
  const standings = { A:{}, B:{} };
  for(const g of ["A","B"]){
    for(const t of groups[g]) standings[g][t] = {Team:t, GP:0, W:0, L:0, SetsPlus:0, SetsMinus:0, GamesPlus:0, GamesMinus:0, Pts:0};
  }
  const h2h = {A:{}, B:{}}; for(const g of ["A","B"]){ for(const t of groups[g]) h2h[g][t] = {}; }
  state.schedule.forEach(([id, , , t1, t2, grp])=>{
    const r = state.matches["g"+id] || {};
    const s1 = Number(r.sets1), s2 = Number(r.sets2);
    const g1 = Number(r.games1), g2 = Number(r.games2);
    const haveSets = isNumber(r.sets1) && isNumber(r.sets2);
    const haveGames = isNumber(r.games1) && isNumber(r.games2);
    if(!haveSets) return;
    standings[grp][t1].GP++; standings[grp][t2].GP++;
    standings[grp][t1].SetsPlus += s1; standings[grp][t1].SetsMinus += s2;
    standings[grp][t2].SetsPlus += s2; standings[grp][t2].SetsMinus += s1;
    if(haveGames){
      standings[grp][t1].GamesPlus += g1; standings[grp][t1].GamesMinus += g2;
      standings[grp][t2].GamesPlus += g2; standings[grp][t2].GamesMinus += g1;
    }
    if(s1>s2){ standings[grp][t1].W++; standings[grp][t2].L++; standings[grp][t1].Pts++; }
    else if(s2>s1){ standings[grp][t2].W++; standings[grp][t1].L++; standings[grp][t2].Pts++; }
  });
  function sortGroup(grp){
    const arr = Object.values(standings[grp]);
    arr.sort((a,b)=>{
      const p = b.Pts - a.Pts; if(p) return p;
      const sd = (b.SetsPlus-b.SetsMinus) - (a.SetsPlus-a.SetsMinus); if(sd) return sd;
      const gd = (b.GamesPlus-b.GamesMinus) - (a.GamesPlus-a.GamesMinus); if(gd) return gd;
      return a.Team.localeCompare(b.Team);
    });
    arr.forEach((r,i)=> r.Rang = i+1);
    return arr;
  }
  return {A: sortGroup("A"), B: sortGroup("B")};
}

function tableHTML(rows){
  return `
  <table>
    <thead>
      <tr>
        <th>#</th><th>Team</th><th>Spiele</th><th>Siege</th><th>Niederl.</th>
        <th>S√§tze +/‚àí</th><th>Spiele +/‚àí</th><th>Punkte</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${r.Rang}</td>
          <td>${r.Team}</td>
          <td>${r.GP}</td>
          <td>${r.W}</td>
          <td>${r.L}</td>
          <td>${r.SetsPlus}:${r.SetsMinus} (${r.SetsPlus - r.SetsMinus})</td>
          <td>${r.GamesPlus}:${r.GamesMinus} (${r.GamesPlus - r.GamesMinus})</td>
          <td>${r.Pts}</td>
        </tr>
      `).join("")}
    </tbody>
  </table>`;
}
function updateTables(){
  const {A, B} = computeStandings();
  document.getElementById("tableA").innerHTML = tableHTML(A);
  document.getElementById("tableB").innerHTML = tableHTML(B);
}

// KO bracket (stacked display)
function renderKO(){
  const br = document.getElementById("koBracket");
  br.innerHTML = "";
  const {A, B} = computeStandings();
  const A1 = A[0]?.Team, A2 = A[1]?.Team;
  const B1 = B[0]?.Team, B2 = B[1]?.Team;
  const K = state.KO;
  // Ensure names adoptable from standings if available
  if(A1 && B2){ K.SF1.t1 = A1; K.SF1.t2 = B2; }
  if(B1 && A2){ K.SF2.t1 = B1; K.SF2.t2 = A2; }

  function block(key, title){
    const m = K[key];
    const el = document.createElement("div");
    el.className = "match-card";
    el.innerHTML = `
      <div class="ko-title">${title}</div>
      <div class="team-row">
        <span class="name">${m.t1 || "‚Äî"}</span>
        <div class="stats">
          <div class="statcol">
            <div class="stat"><span class="label">S√§tze</span><div class="value">${m.s1 || "‚Äî"}</div></div>
          </div>
        </div>
      </div>
      <div class="team-row">
        <span class="name">${m.t2 || "‚Äî"}</span>
        <div class="stats">
          <div class="statcol">
            <div class="stat"><span class="label">S√§tze</span><div class="value">${m.s2 || "‚Äî"}</div></div>
          </div>
        </div>
      </div>
    `;
    return el;
  }

  const col1 = document.createElement("div");
  const col2 = document.createElement("div");
  col1.appendChild(block("SF1","Halbfinale 1 (A1 vs B2)"));
  col2.appendChild(block("SF2","Halbfinale 2 (B1 vs A2)"));
  col1.appendChild(block("P3","Spiel um Platz 3"));
  col2.appendChild(block("F","Finale"));
  br.appendChild(col1); br.appendChild(col2);
}

// QR share
const overlay = document.getElementById("overlay");
const qrBtn = document.getElementById("qrBtn");
const qrImg = document.getElementById("qrImg");
const shareLink = document.getElementById("shareLink");
const closeOverlay = document.getElementById("closeOverlay");
const copyBtn = document.getElementById("copyBtn");

function buildPublicURL(){
  const url = new URL(location.href);
  url.searchParams.set("view", "public");
  return url.toString();
}
function openQR(){
  const link = buildPublicURL();
  shareLink.value = link;
  const qrURL = "https://api.qrserver.com/v1/create-qr-code/?size=480x480&margin=8&data=" + encodeURIComponent(link);
  qrImg.src = qrURL;
  overlay.classList.add("open");
}
function closeQR(){ overlay.classList.remove("open"); }
qrBtn.addEventListener("click", ()=>{
  const link = buildPublicURL();
  if(navigator.share){
    navigator.share({ title: "TCO Doppelmaster 2025 ‚Äì Live", text: "Live‚ÄëTabelle & Spielplan", url: link })
      .catch(()=> openQR());
  }else{
    openQR();
  }
});
closeOverlay.addEventListener("click", closeQR);
copyBtn.addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(shareLink.value); copyBtn.textContent = "Kopiert!"; setTimeout(()=>copyBtn.textContent="Kopieren", 1500);}catch{}
});
overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeQR(); });

// Export
document.getElementById("downloadJson").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "tco_doppelmaster_state.json"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
});

// Boot
(async function boot(){
  const data = await serverLoad();
  if(data){ state = data; } else if(USE_LOCAL_CACHE){ state = loadLocal(); } else { state = {}; }
  ensureState(); if(USE_LOCAL_CACHE) saveLocal(state);
  renderSchedule(); updateTables(); renderKO();
})();
</script>
</body>
</html>
